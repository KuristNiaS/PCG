<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCG 卡片库</title>
<style>
  :root{--bg:#f7f8fb;--card:#fff;--muted:#666;--accent:#2b7cff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#111}
  header{padding:18px 24px;background:#fff;border-bottom:1px solid #eee;display:flex;align-items:center;gap:16px}
  h1{margin:0;font-size:18px}
  .toolbar{display:flex;gap:12px;align-items:center;margin-left:auto}
  .container{display:flex;gap:18px;padding:18px;box-sizing:border-box}
  .panel{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,0.04)}
  .filters{width:300px;flex:0 0 300px}
  .results{flex:1 1 auto;min-width:0}
  .filter-row{margin-bottom:10px}
  label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], select, input[type="number"]{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
  .checkbox-list{display:flex;flex-wrap:wrap;gap:6px}
  .chip{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;font-size:13px;cursor:pointer}
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .card{background:var(--card);border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(20,20,50,0.04);display:flex;flex-direction:column}
  .thumb{height:220px;background:#f0f2f6;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .card-body{padding:8px;font-size:13px}
  .meta{color:var(--muted);font-size:12px;margin-top:6px}
  .btn{background:var(--accent);color:#fff;padding:8px 10px;border-radius:6px;border:none;cursor:pointer}
  .small-btn{padding:6px 8px;font-size:13px}
  .row{display:flex;gap:8px}
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center}
  .modal{background:#fff;padding:16px;border-radius:8px;width:min(880px,96%);max-height:90vh;overflow:auto}
  .modal .thumb{height:360px}
  footer{padding:12px 18px;font-size:13px;color:var(--muted)}
  @media (max-width:800px){
    .container{flex-direction:column}
    .filters{width:100%}
  }
</style>
</head>
<body>

<header>
  <h1>PCG 卡片库</h1>
  <div class="toolbar">
    <span id="api-hint" style="font-size:12px;color:var(--muted)">后端 API: <span id="api-url"></span></span>
  </div>
</header>

<div class="container">
  <div class="panel filters" aria-label="筛选">
    <div class="filter-row">
      <label class="small">关键词（名称/效果）</label>
      <input id="q" type="text" placeholder="搜索卡名或效果（回车/自动触发）">
    </div>

    <div class="filter-row">
      <label class="small">系列（product_series）</label>
      <select id="filter-series"><option value="">全部</option></select>
    </div>

    <div class="filter-row">
      <label class="small">稀有度</label>
      <select id="filter-rarity"><option value="">全部</option></select>
    </div>

    <div class="filter-row">
      <label class="small">类别（多选）</label>
      <div id="filter-category" class="checkbox-list"></div>
    </div>

    <div class="filter-row">
      <label class="small">费用范围</label>
      <div class="row">
        <input id="min-cost" type="number" placeholder="min">
        <input id="max-cost" type="number" placeholder="max">
      </div>
    </div>

    <div class="filter-row">
      <label class="small">PP / DP 最小值</label>
      <div class="row">
        <input id="min-pp" type="number" placeholder="PP min">
        <input id="min-dp" type="number" placeholder="DP min">
      </div>
    </div>

    <div class="filter-row row">
      <button id="btn-reset" class="btn small-btn">重置</button>
      <button id="btn-export" class="btn small-btn">导出 JSON</button>
    </div>

  </div>

  <div class="panel results">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div style="font-size:14px;color:var(--muted)" id="result-count">加载中…</div>
      <div>
        <label style="font-size:13px;color:var(--muted);margin-right:8px">排序</label>
        <select id="sort-by">
          <option value="id_desc">ID ↓</option>
          <option value="id_asc">ID ↑</option>
          <option value="cost_asc">费用 ↑</option>
          <option value="cost_desc">费用 ↓</option>
          <option value="name_asc">名称 ↑</option>
        </select>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>
</div>

<div id="modal-back" class="modal-back" role="dialog" aria-modal="true">
  <div class="modal" id="modal">
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:0 0 320px">
        <div class="thumb" id="modal-thumb"><img src="" alt="card image"></div>
      </div>
      <div style="flex:1">
        <h2 id="modal-title"></h2>
        <div id="modal-meta" class="meta"></div>
        <hr>
        <div id="modal-eff" style="white-space:pre-wrap;margin-top:8px"></div>
        <div style="margin-top:12px" id="modal-more" class="meta"></div>
      </div>
    </div>
    <div style="text-align:right;margin-top:12px">
      <button id="modal-close" class="btn">关闭</button>
    </div>
  </div>
</div>

<footer>提示：图片按 <code>images/{ID}.jpg</code> 命名（或在下方配置 imagesBase），例如：<code>ST02-007.jpg</code></footer>

<script>
/* ====== 配置（保存前请修改下面两个值） ======
   apiBase: 后端 API 根地址（不要以 / 结尾），示例：
       "https://pcg-fga3.onrender.com/api"
   imagesBase: 图片根地址（不以 / 结尾），默认取当前域名 origin + "/images"
*/
let apiBase = "https://pcg-fga3.onrender.com/api"; // ← 改成你的后端地址
let imagesBase = location.origin + "/images";      // ← 改成你图片所在地址（可为 CDN）

document.getElementById('api-url').textContent = apiBase;

// 自动尝试多个后端端点（优先 search -> cards -> /cards.json）
function tryFetchCards(){
  const candidates = [
    (apiBase? (apiBase + "/search") : null),
    (apiBase? (apiBase + "/cards") : null),
    "/cards.json"
  ].filter(Boolean);

  return candidates.reduce((p, url) => {
    return p.catch(() => fetch(url).then(r=> {
      if(!r.ok) return Promise.reject(new Error('no'));
      return r.json();
    }));
  }, Promise.reject(new Error("start")));
}

// 辅助：构建图片 URL（会 encode id）
function imageUrlFor(card) {
  const id = encodeURIComponent(card.id || card.ID || card.Id || "");
  return imagesBase + "/" + id + ".jpg";
}

let allCards = [], filtered = [];

const el = {
  q: document.getElementById('q'),
  series: document.getElementById('filter-series'),
  rarity: document.getElementById('filter-rarity'),
  category: document.getElementById('filter-category'),
  minCost: document.getElementById('min-cost'),
  maxCost: document.getElementById('max-cost'),
  minPP: document.getElementById('min-pp'),
  minDP: document.getElementById('min-dp'),
  grid: document.getElementById('grid'),
  resultCount: document.getElementById('result-count'),
  reset: document.getElementById('btn-reset'),
  exportBtn: document.getElementById('btn-export'),
  sortBy: document.getElementById('sort-by')
};

function normalizeCard(raw){
  // 尽量照顾到不同后端字段名
  return {
    id: raw.id || raw.ID || raw.Id || raw.card_id || "",
    name: raw.name || raw.title || "",
    product_series: raw.product_series || raw.series || raw.product || "",
    category: (raw.category || raw.categories || "").replace(/,/g, '/'),
    rarity: raw.rarity || raw.rank || "",
    color: raw.color || raw.colour || "",
    eff: raw.eff || raw.text || raw.description || "",
    cost: (raw.cost !== undefined && raw.cost !== null)? Number(raw.cost) : null,
    PP: raw.PP !== undefined? Number(raw.PP) : null,
    DP: raw.DP !== undefined? Number(raw.DP) : null
  };
}

function fetchCards(){
  el.resultCount.textContent = '加载中...';
  tryFetchCards().then(data => {
    if(!Array.isArray(data)) data = Array.isArray(data.cards) ? data.cards : [];
    allCards = data.map(normalizeCard);
    initFilters();
    applyFilters();
  }).catch(err=>{
    console.error(err);
    el.resultCount.textContent = '无法从后端获取数据，请检查 apiBase 或部署状态';
  });
}

function unique(arr) { return Array.from(new Set(arr.filter(Boolean))); }

function initFilters(){
  const seriesList = unique(allCards.map(c=>c.product_series)).sort();
  const rarityList = unique(allCards.map(c=>c.rarity)).sort();
  const categories = unique(allCards.flatMap(c => (c.category||'').split('/').map(s=>s.trim()).filter(Boolean))).sort();

  el.series.innerHTML = '<option value="">全部</option>';
  seriesList.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; el.series.appendChild(o); });

  el.rarity.innerHTML = '<option value="">全部</option>';
  rarityList.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; el.rarity.appendChild(o); });

  el.category.innerHTML = '';
  categories.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.type = 'button';
    btn.textContent = cat;
    btn.addEventListener('click', ()=> { btn.classList.toggle('active'); applyFilters(); });
    el.category.appendChild(btn);
  });
}

function selectedCategories(){ return Array.from(el.category.querySelectorAll('.chip.active')).map(n=>n.textContent); }

function applyFilters(){
  const q = el.q.value.trim().toLowerCase();
  const series = el.series.value;
  const rarity = el.rarity.value;
  const minCost = el.minCost.value ? Number(el.minCost.value) : null;
  const maxCost = el.maxCost.value ? Number(el.maxCost.value) : null;
  const minPP = el.minPP.value ? Number(el.minPP.value) : null;
  const minDP = el.minDP.value ? Number(el.minDP.value) : null;
  const cats = selectedCategories();

  filtered = allCards.filter(c=>{
    if(q){
      const hay = ((c.name||'') + ' ' + (c.eff||'')).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(series && c.product_series !== series) return false;
    if(rarity && c.rarity !== rarity) return false;
    if(cats.length){
      const cardCats = (c.category||'').split('/').map(s=>s.trim()).filter(Boolean);
      // 要求包含所有选中项（AND）；若要 OR 把判断改为 some()
      for(const sel of cats) if(!cardCats.includes(sel)) return false;
    }
    if(minCost !== null && (c.cost===null || c.cost < minCost)) return false;
    if(maxCost !== null && (c.cost===null || c.cost > maxCost)) return false;
    if(minPP !== null && (c.PP===null || c.PP < minPP)) return false;
    if(minDP !== null && (c.DP===null || c.DP < minDP)) return false;
    return true;
  });

  sortAndRender();
}

function sortAndRender(){
  const mode = el.sortBy.value;
  const cmp = {
    'id_desc': (a,b)=> (b.id||'').localeCompare(a.id||''),
    'id_asc':  (a,b)=> (a.id||'').localeCompare(b.id||''),
    'cost_asc': (a,b)=> (Number(a.cost)||0) - (Number(b.cost)||0),
    'cost_desc': (a,b)=> (Number(b.cost)||0) - (Number(a.cost)||0),
    'name_asc': (a,b)=> (a.name||'').localeCompare(b.name||'')
  }[mode] || (()=>0);
  filtered.sort(cmp);
  renderGrid();
}

function renderGrid(){
  el.grid.innerHTML = '';
  el.resultCount.textContent = `${filtered.length} 张卡`;
  if(!filtered.length){ el.grid.innerHTML = '<div style="padding:24px;color:var(--muted)">没有匹配结果</div>'; return; }

  filtered.forEach(card=>{
    const node = document.createElement('div'); node.className='card';
    node.innerHTML = `
      <div class="thumb"><img loading="lazy" alt="${escapeHtml(card.name||'')}" src="${imageUrlFor(card)}" onerror="this.onerror=null;this.src='${imagesBase}/placeholder.jpg'"></div>
      <div class="card-body">
        <div style="font-weight:600">${escapeHtml(card.name||'')}</div>
        <div class="meta">${escapeHtml(card.id||'')} • ${escapeHtml(card.product_series||'')} • ${escapeHtml(card.rarity||'')}</div>
        <div class="meta">${escapeHtml(card.category||'')}</div>
      </div>
    `;
    node.addEventListener('click', ()=> openModal(card));
    el.grid.appendChild(node);
  });
}

function openModal(card){
  document.getElementById('modal-back').style.display = 'flex';
  document.getElementById('modal-title').textContent = card.name || card.id;
  document.querySelector('#modal-thumb img').src = imageUrlFor(card);
  document.getElementById('modal-meta').textContent = `${card.id} · ${card.product_series||''} · ${card.rarity||''} · ${card.category||''}`;
  document.getElementById('modal-eff').textContent = card.eff || '';
  document.getElementById('modal-more').textContent = `系列: ${card.series||card.product_series||''}  颜色: ${card.color||''}  费用: ${card.cost||''}  PP:${card.PP||''}  DP:${card.DP||''}`;
}

document.getElementById('modal-close').addEventListener('click', ()=> document.getElementById('modal-back').style.display = 'none');
document.getElementById('modal-back').addEventListener('click', (ev)=> { if (ev.target.id==='modal-back') document.getElementById('modal-back').style.display='none'; });

el.q.addEventListener('input', debounce(()=> applyFilters(), 300));
el.series.addEventListener('change', applyFilters);
el.rarity.addEventListener('change', applyFilters);
el.minCost.addEventListener('input', debounce(applyFilters,300));
el.maxCost.addEventListener('input', debounce(applyFilters,300));
el.minPP.addEventListener('input', debounce(applyFilters,300));
el.minDP.addEventListener('input', debounce(applyFilters,300));
el.reset.addEventListener('click', ()=> {
  el.q.value=''; el.series.value=''; el.rarity.value=''; el.minCost.value=''; el.maxCost.value=''; el.minPP.value=''; el.minDP.value='';
  el.category.querySelectorAll('.chip.active').forEach(n=>n.classList.remove('active'));
  applyFilters();
});
el.exportBtn.addEventListener('click', ()=> { downloadJSON(filtered.length?filtered:allCards, 'cards_export.json'); });
el.sortBy.addEventListener('change', sortAndRender);

function downloadJSON(obj,name){
  const data = JSON.stringify(obj, null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([data], {type:'application/json'}));
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function debounce(fn, wait=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

/* fetch & init */
fetchCards();
</script>
</body>
</html>
